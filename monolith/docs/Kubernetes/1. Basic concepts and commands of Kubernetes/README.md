# Kubernetes(k8s)
Это программное обеспечение для оркестрации контейнеров - автоматизации развёртывания, масштабирования и управления в рамках кластера. Написан на языке Go.
Само приложение кубернетиса состоит из 3 составных частей:
- _**Kubeadm**_ - инструмент для создания, управления и настройки кластера 
- _**Kubelet**_ - это основной агент, работающий на каждом узле в кластере. Следит за работой контейнеров в подах. Обеспечивает запуск, остановку и управление контейнерами приложений в подах.
- _**Kubectl**_ - инструмент интерфейса командной строки(CLI) для работы с кластерами. Это основное средство для управления кластером разработчиком, например: создание, удаление и настройка контейнеров, редактирование и применение конфигов, управление сервисами и деплоями и т.д.

## Структура, подсистема управления и основные понятия

### Структура
1. **Кластер (Cluster)**: это набор машин(узлов). В кластере должен работать как минимум один главный узел.
1. **Главный-узел (Master Node/Control Plane)**: Управляющий компонент Kubernetes, который контролирует кластер и принимает основные решения по планированию и управлению ресурсами.
2. **Рабочий узел (Worker Node)**: Это машина, на которой работают контейнеры, и куда запускаются их компоненты.
3. **Под (Pod)**: Наименьшая управляемая единица в Kubernetes, где запускается один или несколько контейнеров.
4. **Контроллеры (Controllers)**: управляет состоянием кластера, пытаясь привести его от фактического состояния к желаемому. 

### Подсистема управления, стандартные поды
- **Сервер API**: ключевой компонент подсистемы управления, используемый для организации внешнего и внутреннего доступа к функциям Kubernetes. Обновляет состояние объектов, хранящееся в Etcd, позволяя клиентам управлять распределением контейнеров и нагрузки между узлами.
- **Планировщик (scheduler)**: распределяет нагрузку по узлам, определяет где запускать поды и отслеживает использование ресурсов на каждом узле.
- **Менеджер контроллеров(controller manager)**: процесс, выполняющий основные контроллеры, которые взаимодействуют с API-сервером Кубернетиса, создавая, обновляя и удаляя управляемые ими ресурсы(поды, точки входа в сервисы и т.д)
- **Etcd**: высоконадёжное распределённая база данных(NoSQL) для пар ключ-значение. Используется в качестве резервного хранилища для всех данных кластера.
- **Kube-proxy**: является сетевым прокси-сервером и балансировщиком нагрузки. Отвечает за маршрутизацию выходящего трафика на конкретные контейнеры, работающих в пределах пода.

### Основные понятия при работе
- **Сервисы (Services)**: совокупность логически связанных подов и политик доступа к ним. 
- **Развёртывание (Deployment)**: предоставляет обновления для подов. Здесь описывается _желаемое состояние_ для развёртывания. 
- **Container Network Interface(CNI)**: это спецификация, которая позволяет управлять сетевыми интерфейсами контейнеров. Плагины для CNI: Flannel, Weave, Calico
- **Container Runtime Interface (CRI)**: это подключаемый интерфейс, который позволяет создать связь между kubelet и средой выполнения контейнера. Запускается на каждом узле и использует протокол gRPC. Основные рантаймы для работы с контейнерами: cri-dockerd, containerd, CRIO

## Команды
### Kubeadm
Полный список команд можно найти тут - [kubeadm](https://kubernetes.io/docs/reference/setup-tools/kubeadm/)

**Создание мастер-ноды(Control Plane Node)**

Флаги:
- `--pod-network-cidr=<ip-адрес cidr>/<port>` - позволяет задать диапазон виртуальных IP-адресов
- `--cri-socket=<адрес сокета>` - позволяет указать CRI-сокет, если в системе их несколько
- `--ignore-preflight-errors=<список ошибок>`  - список для игнорирования ошибок, указываются через запятую без пробелов.
```
kubeadm init
```

Так же можно создавать конфиги для фаз инициализаций мастер-ноды, указав путь к нему. Например:
```
kubeadm init phase kubeconfig admin --config /etc/kubernetes/kubeadm-config.yaml
```

Пример содержания конфига:
```yaml
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: <ip-адрес машины>
  bindPort: 6443
certificateKey: bb1c954dec9736269b8b149f478c4615cb7d4167ffad737ccc07d1fb08c0c09c
nodeRegistration:
  name: Master01
  taints:
  - effect: NoSchedule
    key: node-role.kubernetes.io/master
  criSocket: unix:///var/run/cri-dockerd.sock
```

**Присоединение узла к кластеру**

Флаги:
- `--cri-socket=<адрес сокета>` - указание конкретного CRI-сокета.
```
kubeadm join <ip-address>:<port>\
    --token=<token-from-step-2> \
    --discovery-token-ca-cert-hash sha256:<ca-hash-from-step-1>
```

**Сброс узла/мастер-узла и его настроек**
```
kubeadm reset
```

**Генерация нового токена для подключения узла**
```
kubeadm token create --print-join-command
```

**Вывод списка токенов для подключения узлов**
```
kubeadm token list 
```

### Kubectl
Полный список команд можно найти тут - [kubectl](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands)

**Вывод информации о кластере**
```
kubectl cluster-info
```

**Просмотр списка узлов кластера**
```
kubectl get node
```

**Просмотр списка всех сервисов**

Флаги:
- `-A` - позволяет увидеть сервисы всех пространств имён
- `-n <namespace>` - позволяет просматривать сервисы в конкретном пространстве имён
```
kubectl get svc
```

**Просмотр списка всех подов**

Флаги:
- `-A` - позволяет увидеть поды всех пространств имён
- `-o wide` - дополнительный флаг, выводит расширенную информацию о подах
- `-n <namespace>` - позволяет просматривать поды в конкретном пространстве имён
```
kubectl get pods
```

**Удаление объектов в пространстве имён**

Флаги:
`-f <path-to-file` - удаление конфига
`-n <namespace> <name>` - удаление объекта в пространстве имён, например пода или пользователя
```
kubectl delete pod -n <namespace> <pod/pods name>
```

**Получение информации о событиях**

Флаги:
- `-A` - выводит все события
- `-n <namespace>` - события пространства имён
```
kubectl get events
```

**Получение логов пода**
```
kubectl get logs -n <namespace> <pod name>
```

**Редактирования конфигов**

Флаги
- `-n <namespace> <name>` - редактирование конфигов в определённом пространстве имён стандартным текстовым редактором
```
kubectl edit <name>
```

**Получение описания объекта**

Флаги:
- `-n <namespace> <name>` - описание объекта в пространстве имён
```
kubectl describe
```

**Применение конфигов**

Флаги:
- `-f <path-to-file>` - применение конфига из определённого файла(локальный файл или удалённый)
```
kubectl apply
```

**Просмотр конфигурации**

Флаги:
- `-n <namespace>` - просмотр конфигурации пространства имён
```
kubectl config view
```

**Запуск proxy**
```
kubectl proxy
```

**Генерация токена для какого-либо объекта, например для пользователя**

Флаги:
- `-n <namespace> <name>` - объект определённого пространства имён
- `--duration=<time>` - время жизни токена. Формат - `3h`, `3m`, `3s`
```
kubectl create token
```

Стандартное время жизни токена - 1 час.

**Вывод всех образов кластера**
```
kubectl get pods --all-namespaces -o jsonpath=" \{.items[*].spec.containers[*].image}" |\
tr -s '[[:space:]]' '\n' |\
sort |\
uniq -c
```

**Снятие ограничений на установку сторонних подов на мастер-узел**
Официальная документация не советует разворачивать пользовательские поды на мастер-ноду в целях безопасности и производительности. Данная команда должна использоваться со знанием последствий.
```
kubectl taint nodes --all node-role.kubernetes.io/control-plane- 
```

Для возвращения к стандартным запретам, используется следующая команда:
```
kubectl taint node <название узла> node-role.kubernetes.io/control-plane:NoSchedule
```

Для вывода списка запретов мастер-ноды:
```
kubectl describe node <название узла> | grep Taints
```

### Прочее
**Вывод всех контейнеров CRI Containerd**
```
ctr --namespace k8s.io container list
```

**Вывод всех контейнеров cri-dockerd**
```
docker container ls -a
```

**Изменение CRI для использования Kubernetes**

Флаги для изменения:
- `--container-runtime-endpoint=<путь до сокета>` - какой CRI использовать
```
vim /var/lib/kubelet/kubeadm-flags.env
```

Пример файла:
```d
KUBELET_KUBEADM_ARGS="--container-runtime=remote --container-runtime-endpoint=/run/cri-dockerd.sock --pod-infra-container-image=k8s.gcr.io/pause:3.6"
```

